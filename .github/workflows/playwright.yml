name: Playwright Tests

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  schedule:
    - cron: '0 0 * * *'  # Run daily at midnight UTC

jobs:
  test:
    name: 'Playwright Tests'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Install Playwright browsers
      run: npx playwright install --with-deps chromium
    
    - name: Run Playwright tests
      run: npm test
      env:
        CI: true
    
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: playwright-report
        path: playwright-report/
        retention-days: 30
        
    - name: Upload test trace files
      if: failure()
      uses: actions/upload-artifact@v3
      with:
        name: playwright-traces
        path: test-results/
        retention-days: 7
        
    - name: Create test summary
      if: always()
      run: |
        npx playwright test --reporter=json > test-results.json
        echo "::group::Test Summary"
        node -e "
          const fs = require('fs');
          try {
            const data = fs.readFileSync('test-results.json', 'utf8');
            const results = JSON.parse(data);
            const total = results.suites.reduce((acc, suite) => acc + suite.specs.length, 0);
            const passed = results.suites.reduce((acc, suite) => acc + suite.specs.filter(s => s.ok).length, 0);
            const failed = total - passed;
            console.log(\`Total Tests: \${total}\`);
            console.log(\`Passed: \${passed}\`);
            console.log(\`Failed: \${failed}\`);
          } catch (err) {
            console.log('Error generating test summary:', err);
          }
        "
        echo "::endgroup::" 